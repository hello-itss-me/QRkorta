/*
  # Создание справочника двигателей

  1. Новые таблицы
    - `motors`
      - `id` (uuid, primary key)
      - `name` (text) - название двигателя
      - `power_kw` (decimal) - мощность в кВт
      - `rpm` (integer) - обороты в минуту
      - `voltage` (integer) - напряжение в В
      - `current` (decimal) - ток в А
      - `efficiency` (decimal) - КПД в %
      - `price_per_unit` (decimal) - цена за единицу
      - `description` (text) - описание
      - `manufacturer` (text) - производитель
      - `is_active` (boolean) - активен ли двигатель
      - `created_at` (timestamp)
      - `updated_at` (timestamp)

  2. Безопасность
    - Включить RLS для таблицы `motors`
    - Добавить политики для чтения, вставки и обновления
*/

-- Создаем таблицу двигателей
CREATE TABLE IF NOT EXISTS motors (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  power_kw decimal(8,2) NOT NULL,
  rpm integer NOT NULL DEFAULT 0,
  voltage integer DEFAULT 380,
  current decimal(8,2) DEFAULT 0,
  efficiency decimal(5,2) DEFAULT 0,
  price_per_unit decimal(12,2) NOT NULL DEFAULT 0,
  description text DEFAULT '',
  manufacturer text DEFAULT '',
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Создаем уникальный индекс для комбинации мощности и оборотов
CREATE UNIQUE INDEX IF NOT EXISTS motors_power_rpm_voltage_key 
  ON motors (power_kw, rpm, voltage) 
  WHERE is_active = true;

-- Включаем RLS
ALTER TABLE motors ENABLE ROW LEVEL SECURITY;

-- Политика для чтения данных (доступно всем)
CREATE POLICY "Anyone can read motors"
  ON motors
  FOR SELECT
  USING (true);

-- Политика для вставки данных (доступно всем для демо)
CREATE POLICY "Anyone can insert motors"
  ON motors
  FOR INSERT
  WITH CHECK (true);

-- Политика для обновления данных (доступно всем для демо)
CREATE POLICY "Anyone can update motors"
  ON motors
  FOR UPDATE
  USING (true);

-- Триггер для автоматического обновления updated_at
CREATE TRIGGER update_motors_updated_at
  BEFORE UPDATE ON motors
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Вставляем начальные данные двигателей
INSERT INTO motors (name, power_kw, rpm, voltage, current, efficiency, price_per_unit, description, manufacturer) VALUES
  ('АИР71А4', 0.55, 1350, 380, 1.4, 68.0, 8500.00, 'Асинхронный двигатель общепромышленного применения', 'Электром'),
  ('АИР71В4', 0.75, 1350, 380, 1.8, 70.0, 9200.00, 'Асинхронный двигатель общепромышленного применения', 'Электром'),
  ('АИР80А4', 1.1, 1350, 380, 2.6, 72.0, 11500.00, 'Асинхронный двигатель общепромышленного применения', 'Электром'),
  ('АИР80В4', 1.5, 1350, 380, 3.4, 74.0, 13200.00, 'Асинхронный двигатель общепромышленного применения', 'Электром'),
  ('АИР90L4', 2.2, 1350, 380, 4.8, 76.0, 16800.00, 'Асинхронный двигатель общепромышленного применения', 'Электром'),
  ('АИР100S4', 3.0, 1350, 380, 6.3, 78.0, 21500.00, 'Асинхронный двигатель общепромышленного применения', 'Электром'),
  ('АИР100L4', 4.0, 1350, 380, 8.2, 80.0, 26300.00, 'Асинхронный двигатель общепромышленного применения', 'Электром'),
  ('АИР112M4', 5.5, 1350, 380, 11.0, 82.0, 34500.00, 'Асинхронный двигатель общепромышленного применения', 'Электром'),
  ('АИР132S4', 7.5, 1350, 380, 15.0, 84.0, 45200.00, 'Асинхронный двигатель общепромышленного применения', 'Электром'),
  ('АИР132M4', 11.0, 1350, 380, 21.5, 85.0, 58900.00, 'Асинхронный двигатель общепромышленного применения', 'Электром'),
  
  -- Двигатели 3000 об/мин
  ('АИР71А2', 0.75, 2850, 380, 1.8, 70.0, 9800.00, 'Асинхронный двигатель высокооборотный', 'Электром'),
  ('АИР71В2', 1.1, 2850, 380, 2.5, 72.0, 12100.00, 'Асинхронный двигатель высокооборотный', 'Электром'),
  ('АИР80А2', 1.5, 2850, 380, 3.2, 74.0, 14500.00, 'Асинхронный двигатель высокооборотный', 'Электром'),
  ('АИР80В2', 2.2, 2850, 380, 4.6, 76.0, 18200.00, 'Асинхронный двигатель высокооборотный', 'Электром'),
  ('АИР90L2', 3.0, 2850, 380, 6.1, 78.0, 23400.00, 'Асинхронный двигатель высокооборотный', 'Электром'),
  ('АИР100S2', 4.0, 2850, 380, 7.8, 80.0, 28700.00, 'Асинхронный двигатель высокооборотный', 'Электром'),
  ('АИР100L2', 5.5, 2850, 380, 10.5, 82.0, 36800.00, 'Асинхронный двигатель высокооборотный', 'Электром'),
  ('АИР112M2', 7.5, 2850, 380, 14.2, 84.0, 47500.00, 'Асинхронный двигатель высокооборотный', 'Электром'),
  ('АИР132S2', 11.0, 2850, 380, 20.8, 85.0, 62300.00, 'Асинхронный двигатель высокооборотный', 'Электром'),
  ('АИР132M2', 15.0, 2850, 380, 28.0, 86.0, 78900.00, 'Асинхронный двигатель высокооборотный', 'Электром'),
  
  -- Двигатели 1000 об/мин
  ('АИР90L6', 1.1, 950, 380, 2.8, 70.0, 15200.00, 'Асинхронный двигатель тихоходный', 'Электром'),
  ('АИР100L6', 1.5, 950, 380, 3.7, 72.0, 18500.00, 'Асинхронный двигатель тихоходный', 'Электром'),
  ('АИР112MA6', 2.2, 950, 380, 5.2, 74.0, 23800.00, 'Асинхронный двигатель тихоходный', 'Электром'),
  ('АИР112MB6', 3.0, 950, 380, 6.8, 76.0, 28900.00, 'Асинхронный двигатель тихоходный', 'Электром'),
  ('АИР132S6', 4.0, 950, 380, 8.8, 78.0, 35600.00, 'Асинхронный двигатель тихоходный', 'Электром'),
  ('АИР132M6', 5.5, 950, 380, 11.8, 80.0, 43200.00, 'Асинхронный двигатель тихоходный', 'Электром')
ON CONFLICT DO NOTHING;
